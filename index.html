<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Donation Widget</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    .donation-widget {
      max-width: 400px;
      margin: 20px auto;
      padding: 30px;
      background: linear-gradient(135deg, #000568 0%, #56a0d3 100%);
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0,5,104,0.3);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .donation-header { text-align: center; margin-bottom: 25px; }
    .donation-title {
      font-size: 28px; font-weight: 700; margin-bottom: 10px;
      background: linear-gradient(45deg, #FFFF00, #ff6980);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .donation-counter {
      background: rgba(255,255,255,0.2); padding: 15px; border-radius: 15px;
      text-align: center; margin-bottom: 25px; backdrop-filter: blur(10px);
    }
    .counter-number { font-size: 32px; font-weight: 800; color: #FFFF00; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .counter-label { font-size: 14px; opacity: 0.9; margin-top: 5px; }
    .amount-buttons {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;
    }
    .amount-btn {
      padding: 15px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3);
      color: white; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;
      font-weight: 600; font-size: 16px; text-align: center;
    }
    .amount-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    .amount-btn.active { background: linear-gradient(45deg, #ff6980, #FFFF00); color: #000568; border-color: #ff6980; font-weight: 700; }
    .amount-btn[data-amount="25"] { grid-column: span 2; }
    .custom-amount {
      width: 100%; padding: 15px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1);
      color: white; border-radius: 12px; margin-bottom: 20px; font-size: 16px;
    }
    .custom-amount::placeholder { color: rgba(255,255,255,0.7); }
    .custom-amount:focus {
      outline: none; border-color: #ff6980; background: rgba(255,255,255,0.15);
      box-shadow: 0 0 0 2px rgba(255,105,128,0.3);
    }
    .donate-btn {
      width: 100%; padding: 18px; background: linear-gradient(45deg, #ff6980, #FFFF00); color: #000568;
      border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer;
      transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px;
      box-shadow: 0 4px 15px rgba(255,105,128,0.4);
    }
    .donate-btn:hover {
      transform: translateY(-2px); box-shadow: 0 10px 25px rgba(255,105,128,0.5);
      background: linear-gradient(45deg, #FFFF00, #ff6980);
    }
    .donate-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .powered-by { text-align: center; margin-top: 20px; font-size: 12px; opacity: 0.7; }
    .success-message, .error-message {
      display: none; margin-top: 15px; padding: 15px; border-radius: 12px; text-align: center;
    }
    .success-message { background: #10b981; }
    .error-message { background: #ef4444; }
  </style>
</head>
<body>
  <div class="donation-widget">
    <div class="donation-header">
      <h2 class="donation-title">Buy Me a Coffee</h2>
      <p>Fuel the next episode with some caffeine! â˜•</p>
    </div>

    <div class="donation-counter">
      <div class="counter-number" id="donationCount">0</div>
      <div class="counter-label">coffee supporters â˜•</div>
    </div>

    <div class="amount-buttons">
      <button class="amount-btn" data-amount="4">Regular<br><span style="font-size:12px;opacity:0.8;">$4</span></button>
      <button class="amount-btn" data-amount="6">Fancy (mocha ðŸ˜‹)<br><span style="font-size:12px;opacity:0.8;">$6</span></button>
      <button class="amount-btn" data-amount="25">A week of coffee! ðŸ¥¹<br><span style="font-size:12px;opacity:0.8;">$25</span></button>
    </div>

    <input type="number" class="custom-amount" placeholder="Custom amount ($)" id="customAmount" min="1" />

    <button class="donate-btn" id="donateButton">Buy Me Coffee â˜•</button>

    <div class="success-message" id="successMessage">
      Thanks for the coffee! Time to brew the next episode! â˜•ðŸŽ‰
    </div>
    <div class="error-message" id="errorMessage">
      Something went wrong. Please try again.
    </div>

    <div class="powered-by">Powered by Stripe â€¢ Secure & Safe</div>
  </div>

<script>
const stripe = Stripe('pk_live_51RtiN2GWp52bfzHgKk2PcownnZFv0q44ibPoekDzbtwNTen21zGFOnAHDqGylkMkzrIx9uiQVCicZDyC5dE4SR9600YV0AObLa'); // <-- your Stripe publishable key
let selectedAmount = 0;

// Fetch current donation count from Supabase
async function fetchDonationCount() {
    try {
        const res = await fetch('https://cwccgwjvphpluyzxqzxh.supabase.co/rest/v1/donations?select=id&count=exact', {
            method: 'GET',
            headers: {
                apikey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3Y2Nnd2p2cGhwbHV5enhxenhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NjcyMDcsImV4cCI6MjA3MDI0MzIwN30.zfX9vl-mv68ceT9FcobLibMuhZOxR3cs9tBlNcpmxeo',
                Authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3Y2Nnd2p2cGhwbHV5enhxenhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NjcyMDcsImV4cCI6MjA3MDI0MzIwN30.zfX9vl-mv68ceT9FcobLibMuhZOxR3cs9tBlNcpmxeo',
                Prefer: 'count=exact'
            }
        });
        const total = res.headers.get('content-range')?.split('/')?.[1] || 0;
        document.getElementById('donationCount').textContent = total;
    } catch (err) {
        console.error('Count fetch error', err);
    }
}
fetchDonationCount();

// Preset amount selection
document.querySelectorAll('.amount-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedAmount = parseInt(btn.dataset.amount);
        document.getElementById('customAmount').value = '';
    });
});

// Clear preset if typing custom
document.getElementById('customAmount').addEventListener('input', () => {
    document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
    selectedAmount = 0;
});

// Handle donation - WITH DEBUG LOGGING
document.getElementById('donateButton').addEventListener('click', async function() {
    const customAmount = parseFloat(document.getElementById('customAmount').value);
    const amount = selectedAmount || customAmount;

    if (!amount || amount < 1) {
        alert('Enter a valid amount.');
        return;
    }

    // Preset Stripe links
    if (selectedAmount) {
        if (amount === 4) window.location.href = 'https://donate.stripe.com/fZubJ1dy01mg1lgdphcEw03';
        if (amount === 6) window.location.href = 'https://donate.stripe.com/28E6oHbpS1mg7JEetlcEw02';
        if (amount === 25) window.location.href = 'https://donate.stripe.com/5kQ00jgKcgha3to0CvcEw01';
        return;
    }

    // Custom amount via backend
    try {
        this.disabled = true;
        this.textContent = 'Processing...';
        
        console.log('Making request to /api/create-checkout with amount:', amount);
        
        const res = await fetch('/api/create-checkout', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ amount })
        });
        
        console.log('Response status:', res.status);
        console.log('Response headers:', Object.fromEntries(res.headers.entries()));
        
        // Get response as text first to see what we're actually getting
        const responseText = await res.text();
        console.log('Raw response:', responseText);
        
        let data;
        try {
            data = JSON.parse(responseText);
        } catch (parseError) {
            console.error('JSON parse error:', parseError);
            console.error('Response was:', responseText.substring(0, 200)); // First 200 chars
            throw new Error(`Server returned invalid JSON. Response: ${responseText.substring(0, 100)}`);
        }
        
        if (!res.ok) {
            console.error('API Error:', data);
            throw new Error(data.error || `HTTP ${res.status}: ${res.statusText}`);
        }
        
        if (data.url) {
            // Optimistically increment counter
            const counterEl = document.getElementById('donationCount');
            counterEl.textContent = parseInt(counterEl.textContent) + 1;
            window.location.href = data.url;
        } else {
            throw new Error('No checkout URL returned');
        }
    } catch (err) {
        console.error('Payment error:', err);
        alert(`Payment error: ${err.message}`);
        
        // Show error message
        const errorEl = document.getElementById('errorMessage');
        errorEl.style.display = 'block';
        setTimeout(() => errorEl.style.display = 'none', 5000);
    } finally {
        this.disabled = false;
        this.textContent = 'Buy Me Coffee â˜•';
    }
});
</script>
</body>
</html>
